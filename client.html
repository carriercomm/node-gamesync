<!DOCTYPE html>
<html>
<head>
    <script type="text/javascript" src="/socket.io/socket.io.js"></script>
    <script type="text/javascript" src="/game.js"></script>
</head>
<body>
    <canvas id="paper" width="640" height="480" />
</body>
<script>
"use strict";
// ----- input ----------------------------------------------------------------

var Key = { LEFT: 37, RIGHT: 39 };

var keys = (function(){
    var _keys = { dirty: false };

    function isRelevant (key) {
        for (var k in Key) {
            if (Key[k] == key) return true;
        }
        return false;
    }

    window.onkeydown = function (e) {
        if (! isRelevant (e.keyCode)) return;
        if (! _keys [e.keyCode]) {
            _keys [e.keyCode] = true;
            _keys.dirty = true;
        }
    }

    window.onkeyup = function (e) {
        if (! isRelevant (e.keyCode)) return;
        if (_keys [e.keyCode]) {
            delete _keys [e.keyCode];
            _keys.dirty = true;
        }
    }

    return _keys;
})();

// ----- view -----------------------------------------------------------------

var render = (function(){
    var WIDTH = 600, HEIGHT = 300;
    var WIDTH2 = WIDTH/2, HEIGHT2 = HEIGHT/2;

    var ctx = document.getElementById("paper").getContext("2d");
    var fg = "#FFF", bg = "#000";

    function drawBall (ball) {
        ctx.fillStyle = fg;
        ctx.fillRect (WIDTH2+WIDTH2*ball.x-3,
                      HEIGHT2+HEIGHT2*ball.y-3, 6, 6);
    }

    function drawPaddle (x, y) {
        ctx.fillStyle = fg;
        ctx.fillRect (WIDTH2+WIDTH2*x-32,
                      HEIGHT2+HEIGHT2*y-3,64, 6);
    }

    return function (state) {
        ctx.fillStyle = bg;
        ctx.fillRect (0, 0, WIDTH, HEIGHT);
        drawBall (state.ball);
        drawPaddle (state.paddles[0], -0.9);
        drawPaddle (state.paddles[1],  0.9);
    }
})();

// ----- net/state ------------------------------------------------------------


function runGame () {
    var socket = io.connect (document.URL);

    function slowSend (data) {
    //  setTimeout (function () {
            socket.json.send (data);
    //  }, 100);
    }

    var inputId = null;

    var predictionFrame = null;
    var lastInputAckId = null;
    var lastNewInput = null;

    function combineInputs (all, local) {
        for (var i = 0; i < all.length ; ++i) {
            if (all[i].id === local.id) {
                all[i] = local;
                break;
            }
        }
        return all;
    }

    socket.on ("connect", function () {
        socket.on ("message", function (data) {
            if (data.error) {
                alert (data.error);
                return;
            }
            if (data.notifyInputId) {
                inputId = data.notifyInputId;
                return;
            }

            if (lastInputAckId && data.ackInputs
            && data.ackInputs.indexOf (lastInputAckId) >= 0) {
                console.log ("Server acked last input.");
                predictionFrame = null;
                lastInputAckId = null;
                lastNewInput = null;
            }

            if (predictionFrame) {
                render (predictionFrame);
            } else {
                render (data.state);
            }

            if (keys.dirty) {
                lastNewInput = {paddle: keys[Key.LEFT] ? -1 : keys[Key.RIGHT] ? 1 : 0};
                lastNewInput.id = inputId;
                lastInputAckId = Math.random().toString().substr(2);

                slowSend ({
                    ackId: lastInputAckId,
                    input: lastNewInput,
                    frame: data.frame
                });
                keys.dirty = false;

                predictionFrame = game.step (combineInputs (data.inputs, lastNewInput),
                    predictionFrame ? predictionFrame : data.state);
            }
            else if (predictionFrame) {
                predictionFrame = game.step (combineInputs (data.inputs, lastNewInput),
                    predictionFrame);
            }
        });
    });
}
runGame ();

// ----------------------------------------------------------------------------
</script>
</html>
