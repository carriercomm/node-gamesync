<!DOCTYPE html>
<html>
<head>
    <script type="text/javascript" src="/socket.io/socket.io.js"></script>
    <script type="text/javascript" src="/game.js"></script>
    <script type="text/javascript" src="/client.js"></script>
</head>
<body>
    <canvas id="paper" width="640" height="480" />
</body>
<script>
"use strict";
// ----- input ----------------------------------------------------------------

var getInput = (function(){
    var Key = { LEFT: 37, RIGHT: 39 };
    var _keys = { dirty: false };

    function isRelevant (key) {
        for (var k in Key) {
            if (Key[k] == key) return true;
        }
        return false;
    }

    window.onkeydown = function (e) {
        if (! isRelevant (e.keyCode)) return;
        if (! _keys [e.keyCode]) {
            _keys [e.keyCode] = true;
            _keys.dirty = true;
        }
    }

    window.onkeyup = function (e) {
        if (! isRelevant (e.keyCode)) return;
        if (_keys [e.keyCode]) {
            delete _keys [e.keyCode];
            _keys.dirty = true;
        }
    }

    return function () {
        console.log (_keys.dirty);
        if (_keys.dirty) {
            _keys.dirty = false;
            return {paddle: _keys[Key.LEFT] ? -1 : _keys[Key.RIGHT] ? 1 : 0};
        }
        return null;
    }
})();

// ----- view -----------------------------------------------------------------

var render = (function(){
    var WIDTH = 600, HEIGHT = 300;
    var WIDTH2 = WIDTH/2, HEIGHT2 = HEIGHT/2;

    var ctx = document.getElementById("paper").getContext("2d");
    var fg = "#FFF", bg = "#000";

    function drawBall (ball) {
        ctx.fillStyle = fg;
        ctx.fillRect (WIDTH2+WIDTH2*ball.x-3,
                      HEIGHT2+HEIGHT2*ball.y-3, 6, 6);
    }

    function drawPaddle (x, y) {
        ctx.fillStyle = fg;
        ctx.fillRect (WIDTH2+WIDTH2*x-32,
                      HEIGHT2+HEIGHT2*y-3,64, 6);
    }

    return function (state) {
        ctx.fillStyle = bg;
        ctx.fillRect (0, 0, WIDTH, HEIGHT);
        drawBall (state.ball);
        drawPaddle (state.paddles[0], -0.9);
        drawPaddle (state.paddles[1],  0.9);
    }
})();

// ----------------------------------------------------------------------------

runGame (render, getInput);

// ----------------------------------------------------------------------------
</script>
</html>
